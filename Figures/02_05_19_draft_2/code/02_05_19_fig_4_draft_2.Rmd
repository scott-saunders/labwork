---
title: "Figure 4 Draft 2"
fontsize: 12pt
date: "02_07_19 "
output:
  html_document:
    self_contained: false
    toc: true
    code_folding: hide
  github_document:
    pandoc_args: --webtex
---


```{r setup, echo=T, message=FALSE, warning=FALSE}
library(tidyverse)
library(cowplot)
library(broom) 
library(modelr) 
library(viridis)
library(lubridate)
library(hms)
library(knitr)
library(kableExtra)
library(patchwork)


knitr::opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE, echo = TRUE, message=FALSE, warning=FALSE, fig.align="center")

source("../../../IDA/tools/echem_processing_tools.R")
source("../../../IDA/tools/plotting_tools.R")

theme_set(theme_1())
```

# Intro

```{r}
blank_dm <- read_csv("../data/02_07_19_blank_dm_estimates.csv")

blank_dap <- read_csv("../data/02_07_19_blank_dap_estimates.csv")

biofilm_dap <- read_csv("../data/01_28_19_swv_gc_dap_estimates_aggregate_updated.csv")

biofilm_dm_fits <- read_csv("../data/02_07_19_biofilm_dm_fits.csv") %>% 
  mutate(exp_id = as.character(exp_id))
```

```{r}
dm_estimates_wDap <- left_join(biofilm_dm_fits, 
                               biofilm_dap %>% 
                                 filter(treatment=='control') %>% 
                                 select(exp_id, run, r.squared, dap, dap_high, dap_low), 
                               by = c('exp_id','run'))


dm_from_a_noFlux <- function(estimate, i_0, dap, t_s=0.1){
  
  dm <- ( i_0^2 * dap * t_s ) / ( 4*pi* estimate^2)
  
  dm
}

dm_from_a_OG <- function(estimate, i_0, dap, t_s=0.1){
  
  dm <- ( i_0^2 * dap * t_s ) / ( pi* estimate^2)
  
  dm
}

```


```{r}
dm_estimates_og <- dm_estimates_wDap %>% 
  filter(model=='og') %>% 
  mutate(dm_soak = dm_from_a_OG(estimate = estimate, i_0 = i0_soak, dap = dap, t_s = 0.008)) %>% 
  mutate(dm_transfer = dm_from_a_OG(estimate = estimate, i_0 = i0_transfer, dap = dap, t_s = 0.008))

dm_estimates_noFlux <- dm_estimates_wDap %>% 
  filter(model=='no_flux') %>% 
  mutate(dm_soak = dm_from_a_noFlux(estimate = estimate, i_0 = i0_soak, dap = dap, t_s = 0.008)) %>% 
  mutate(dm_transfer = dm_from_a_noFlux(estimate = estimate, i_0 = i0_transfer, dap = dap, t_s = 0.008)) 

dm_estimates_tidy <- rbind(dm_estimates_og,dm_estimates_noFlux) %>% 
  rowwise() %>% 
  mutate(mean = mean(c(dm_soak, dm_transfer)))

mean_biofilm_dap <- mean(dm_estimates_tidy$dap, na.rm = T)

ggplot(dm_estimates_tidy, aes(x = exp_id, y = mean, color = factor(run))) + 
  geom_pointrange(aes(ymin = dm_transfer, ymax = dm_soak), position = position_jitter(height = 0))+
  geom_pointrange(aes(y = dap, ymin = dap_low, ymax = dap_high), position = position_jitter(height = 0), shape = 2)+
  geom_hline(yintercept = mean_biofilm_dap, linetype = 2)+
  facet_wrap(~model) + 
  scale_y_log10(limits = c(1e-9,NA)) + 
  scale_color_viridis(discrete = T) + 
  labs(y = "D estimate (cm^2 / sec)")
```

```{r}
d_combined <- dm_estimates_tidy %>% 

  mutate(dm = mean) %>% 
  gather(key=d_cat,val=d_est,dap,dm) %>% 
  mutate(ymax = if_else(d_cat=='dap', dap_high, dm_soak)) %>% 
  mutate(ymin = if_else(d_cat=='dap', dap_low, dm_transfer)) %>% 
  mutate(biofilm = 'biofilm')

ggplot(d_combined, 
       aes(x = d_cat, y = d_est, shape = exp_id)) + 
  geom_pointrange(aes(ymin = ymin, ymax = ymax), position = position_jitter(height = 0))+
  facet_wrap(~model) + 
  scale_y_log10(limits = c(1e-9,NA))
```

```{r}
d_blank_noFlux <- blank_dm %>% 
  filter(model=='no_flux') %>% 
  mutate(dap = blank_dap$dap, dap_high = blank_dap$dap_high, dap_low = blank_dap$dap_low) %>% 
  mutate(dm = dm_soak) %>% 
  gather(key=d_cat,val=d_est,dap,dm) %>% 
  mutate(ymax = if_else(d_cat=='dap', dap_high, dm_soak)) %>% 
  mutate(ymin = if_else(d_cat=='dap', dap_low, dm_soak)) %>%
  mutate(biofilm = 'blank') %>% 
  mutate(exp_id = 'blank') %>% 
  distinct(d_est,.keep_all = T)

d_blank_og <- blank_dm %>% 
  filter(model=='og') %>% 
  mutate(dap = blank_dap$dap, dap_high = blank_dap$dap_high, dap_low = blank_dap$dap_low) %>% 
  mutate(dm = dm_soak) %>% 
  gather(key=d_cat,val=d_est,dap,dm) %>% 
  mutate(ymax = if_else(d_cat=='dap', dap_high, dm_soak)) %>% 
  mutate(ymin = if_else(d_cat=='dap', dap_low, dm_soak)) %>%
  mutate(biofilm = 'blank') %>% 
  mutate(exp_id = 'blank') %>% 
  distinct(d_est,.keep_all = T)
#dap_estimates

d_combined_wBlank_noFlux <- bind_rows(d_combined, d_blank_noFlux) %>% 
  filter(model=='no_flux')

d_combined_wBlank_OG <- bind_rows(d_combined, d_blank_og) %>% 
  filter(model=='og')

ggplot(d_combined_wBlank_noFlux, 
       aes(x = d_cat, y = d_est, fill = exp_id)) + 
  geom_pointrange(aes(ymin = ymin, ymax = ymax), position = position_jitter(height = 0,width=0.2),shape=21)+
  facet_wrap(~biofilm, scales='free') + 
  scale_y_log10(limits = c(1e-9,1e-4))+
  scale_fill_viridis(discrete = T) +
  scale_x_discrete(breaks = c('dap','dm'), labels=c(expression(D[ap]),expression(D[m]))) +
  labs(x='',y=expression("Estimate ("~cm^2 / sec~")"))+
  guides(fill=F) + 
  theme(axis.text.x = element_text( size=14) ) 

ggplot(d_combined_wBlank_OG, 
       aes(x = d_cat, y = d_est, fill = exp_id)) + 
  geom_pointrange(aes(ymin = ymin, ymax = ymax), position = position_jitter(height = 0,width=0.2),shape=21)+
  facet_wrap(~biofilm, scales='free') + 
  scale_y_log10(limits = c(1e-9,1e-4))+
  scale_fill_viridis(discrete = T) +
  scale_x_discrete(breaks = c('dap','dm'), labels=c(expression(D[ap]),expression(D[m]))) +
  labs(x='',y=expression("Estimate ("~cm^2 / sec~")"))+
  guides(fill=F) + 
  theme(axis.text.x = element_text( size=14) )
```

```{r}
ggplot(d_combined_wBlank_noFlux %>% filter(exp_id!='1'), 
       aes(x = d_cat, y = d_est, fill = exp_id)) + 
  geom_pointrange(aes(ymin = ymin, ymax = ymax), position = position_jitter(height = 0,width=0.2),shape=21)+
  facet_wrap(~biofilm, scales='free') + 
  scale_y_log10(limits = c(1e-9,1e-4))+
  scale_fill_viridis(discrete = T) +
  scale_x_discrete(breaks = c('dap','dm'), labels=c(expression(D[ap]),expression(D[m]))) +
  labs(x='',y=expression("Estimate ("~cm^2 / sec~")"))+
  guides(fill=F) + 
  theme(axis.text.x = element_text( size=14) )
```