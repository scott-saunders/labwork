---
title: "Psoralen treatment - Non equilibrium #3"
subtitle: "Processing"
fontsize: 12pt
date: "01_23_19 "
output:
  html_document:
    self_contained: false
    toc: true
    code_folding: hide
  github_document:
    pandoc_args: --webtex
---


```{r setup, echo=T, message=FALSE, warning=FALSE}
library(tidyverse)
library(cowplot)
library(broom) 
library(modelr) 
library(viridis)
library(lubridate)
library(hms)

knitr::opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE, echo = TRUE, message=FALSE, warning=FALSE, fig.align="center")

source("../../tools/echem_processing_tools.R")
source("../../tools/plotting_tools.R")

theme_set(theme_1())
```

# Import

## SWV data

First, import all SWV files. 
```{r}

SWV_file_paths <-  dir(path='../Data', pattern = "[SWV]+.+[txt]$",recursive = T,full.names = T)

SWV_filenames <- basename(SWV_file_paths)

swv_data_cols <-  c('E','i1','i2')

filename_cols = c('PHZadded','treatment','reactor','run','echem','rep')

swv_skip_rows=18
  

swv_data <- echem_import_to_df(filenames = SWV_filenames, 
                                       file_paths = SWV_file_paths, 
                                       data_cols = swv_data_cols, 
                                       skip_rows = swv_skip_rows,
                                       filename_cols = filename_cols,
                                       rep = T) %>% 
  mutate(rep=rep-1)
```

These are all of the scans taken in the transfer reactor. This is i1, which is usually used for the downstream quantification:

```{r}

ggplot(swv_data %>% filter(electrode=='i1' & reactor=='transfer'), aes(x=E, y=current,color=rep,group=factor(rep)))+geom_path()+
  facet_grid(treatment~run,scales='free')+
  scale_color_viridis()

```

It looks about as expected. Unfortunately there is a high background signal that comes up in the psoralen starting at run 3. I switched to SWVslow parameters after that. 


Here's i2:
```{r}
ggplot(swv_data %>% filter(electrode=='i2' & reactor=='transfer'), aes(x=E, y=current,color=rep,group=factor(rep)))+geom_path()+
  facet_grid(treatment~run,scales='free')+
  scale_color_viridis()
```
It looks typical. Taking an SWV after GC results in this weird peak at the collector electrode...at least it's consistent. For run 5, the psoralen biofilm was started with SWV fast parameters and it looked bad, so I restarted it with swv slow parameters, so the real scans are very tiny on this plot. 


Let's focus on the first run for both conditions. 
```{r}

ggplot(swv_data %>% filter(electrode=='i1' & reactor=='transfer' & run==1 & rep<14 & rep>0), aes(x=E, y=current,color=rep,group=factor(rep)))+geom_path()+
  facet_wrap(~treatment,scales='free')+
  scale_color_viridis()
```
It looks pretty good, although the psoralen data may need some loess smoothing. Let's ignore that for now.

## GC data

Let's import all the GC data. 

```{r}

GC_file_paths <-  dir(path='../Data', pattern = "[GC]+.+[txt]$",recursive = T,full.names = T)

GC_filenames <- basename(GC_file_paths)

gc_data_cols <-  c('E','i1','i2','t')

filename_cols = c('PHZadded','treatment','reactor','run','echem','rep')

gc_skip_rows=21
  

gc_data <- echem_import_to_df(filenames = GC_filenames, 
                                       file_paths = GC_file_paths, 
                                       data_cols = gc_data_cols, 
                                       skip_rows = gc_skip_rows,
                                       filename_cols = filename_cols,
                                       rep = T)

```

Here's all the data plotted. 
```{r}

ggplot(gc_data %>% filter(reactor=='transfer'), aes(x=E, y=current,color=rep,group=electrode))+
  geom_point(size=0.5)+
  facet_grid(treatment~run,scales='free')+
  scale_x_reverse() + 
  scale_color_viridis(discrete = F)
```
Eh, this data looks ok, but not great. I do not understand why the curves get "wiggly" or why such a weird high signal pops up on the generators. These weird effects seemed to be indpendent of potentiostat and not sensitive to minor changes in where the IDA faced in the reactors. I think the 760b might give somewhat smoother results, but it's perplexing that it is relatively inconsistent. Note that for runs 1 and 2 the 760e was used with the control and the 760b with psoralen, and runs 3 and 4 were the exact opposite.

It looks like the collectors were somewhat more immune to the wiggliness than the generators, but I do worry that these anomalies will affect the quantification...For now, I think we should look at the series more closely, and try to make sure that the wiggles are small compared to the main PYO peak arising around 250mV. Assuming that is true, I think we should be fine.

Let's look at the collector data specifically:
```{r}
ggplot(gc_data %>% filter(reactor=='transfer' & electrode=='i2'), aes(x=E, y=-current,color=rep,group=factor(rep))) +
  geom_path()+
  facet_grid(treatment~run,scales='free')+
  scale_color_viridis()+
  scale_x_reverse()
```


# Quantification

## Control SWV

```{r}
swv_control_data <- swv_data %>% 
  filter(treatment=='control' & PHZaddedInt==75)

unique_id_cols = c('PHZadded','treatment','reactor','run','echem','rep','minutes','PHZaddedInt','electrode')

swv_control_signals <- echem_signal(df = swv_control_data, 
                            unique_id_cols = unique_id_cols,
                            max_interval = c(-0.2,-0.4), 
                            min_interval = c(0.0,-0.4)) 
```

```{r}
ggplot(swv_control_data %>% filter(electrode=='i1'), 
       aes(x = E, y = current, color = rep, shape=reactor, group=factor(rep))) +
  geom_path()+
  geom_point(data = swv_control_signals %>% filter(electrode=='i1'), 
             aes(x = E_from_maxs, y = current_from_maxs), color = 'red') + 
  geom_point(data = swv_control_signals %>% filter(electrode=='i1'), 
             aes(x = E_from_mins, y = current_from_mins), color = 'blue') +
  facet_wrap(~run,scales='free')+
  scale_x_reverse()+
  scale_color_viridis()
```

```{r}
ggplot(swv_control_data %>% filter(electrode=='i2'), 
       aes(x = E, y = current, color = rep, shape=reactor, group=factor(rep))) + 
  geom_path()+
  geom_point(data = swv_control_signals %>% filter(electrode=='i2'), 
             aes(x = E_from_maxs, y = current_from_maxs), color = 'red') + 
  geom_point(data = swv_control_signals %>% filter(electrode=='i2'), 
             aes(x = E_from_mins, y = current_from_mins), color = 'blue') +
  facet_wrap(~run,scales='free')+
  scale_x_reverse()+
  scale_color_viridis()
```

```{r}
ggplot(swv_control_signals, aes(x=rep, y=signal,shape=reactor,color=factor(run)))+geom_line()+geom_point()+
  facet_wrap(~electrode)+
  scale_color_viridis(discrete = T)
```

## Psoralen SWV
```{r}
swv_psoralen_data <- swv_data %>% 
  filter(treatment=='psoralen' & PHZaddedInt==75)

unique_id_cols = c('PHZadded','treatment','reactor','run','echem','rep','minutes','PHZaddedInt','electrode')

swv_psoralen_signals <- echem_signal(df = swv_psoralen_data, 
                            unique_id_cols = unique_id_cols,
                            max_interval = c(-0.2,-0.4), 
                            min_interval = c(0.0,-0.4)) 
```

```{r}
ggplot(swv_psoralen_data %>% filter(electrode=='i1' & reactor=='transfer' & rep>0), 
       aes(x = E, y = current, color = rep, shape=reactor, group=factor(rep))) +
  geom_path()+
  geom_point(data = swv_psoralen_signals %>% filter(electrode=='i1' & reactor=='transfer' & rep>0), 
             aes(x = E_from_maxs, y = current_from_maxs), color = 'red') + 
  geom_point(data = swv_psoralen_signals %>% filter(electrode=='i1' & reactor=='transfer' & rep>0), 
             aes(x = E_from_mins, y = current_from_mins), color = 'blue') +
  facet_wrap(~run,scales='free')+
  scale_x_reverse()+
  scale_color_viridis()
```


## All GC

```{r}
gc_data_i2 <- gc_data %>% 
  filter(electrode=='i2' & PHZaddedInt==75) %>% 
  mutate(current=-current)

unique_id_cols = c('PHZadded','treatment','reactor','run','echem','rep','minutes','PHZaddedInt','electrode')

gc_signals <- echem_signal(df = gc_data_i2, 
                            unique_id_cols = unique_id_cols,
                            max_interval = c(-0.399,-0.399), 
                            min_interval = c(0.0,-0.4)) 

```

```{r}
ggplot(gc_data_i2 %>% filter(reactor=='transfer'), 
       aes(x = E, y = current, color = rep, shape=reactor, group=factor(rep))) +
  geom_path()+
  geom_point(data = gc_signals %>% filter(reactor=='transfer'), 
             aes(x = E_from_maxs, y = current_from_maxs), color = 'red') + 
  geom_point(data = gc_signals %>% filter(reactor=='transfer'), 
             aes(x = E_from_mins, y = current_from_mins), color = 'blue') +
  facet_grid(treatment~run,scales='free')+
  scale_x_reverse()+
  scale_color_viridis()
```


```{r}
ggplot(gc_data_i2 %>% filter(reactor=='soak' & rep==1), 
       aes(x = E, y = current, color = factor(run), shape=reactor, linetype=treatment)) +
  geom_path()+
  geom_point(data = gc_signals %>% filter(reactor=='soak'), 
             aes(x = E_from_maxs, y = current_from_maxs), color = 'red') + 
  geom_point(data = gc_signals %>% filter(reactor=='soak'), 
             aes(x = E_from_mins, y = current_from_mins), color = 'blue') +
  scale_x_reverse()+
  scale_color_viridis(discrete = T)
```

```{r}
ggplot(gc_signals, aes(x = rep, y = signal,shape=reactor, color=factor(run)))+
  geom_line()+
  geom_point()+
  facet_wrap(reactor~treatment,scales='free')+
  scale_color_viridis(discrete = T)
```

```{r}
swv_gc_control <- left_join(swv_control_signals %>% filter(run<=4),gc_signals,
                            by=c('run','rep','reactor','treatment'),
                            suffix=c('_from_swv','_from_gc'))

#write_csv(swv_gc_control,"./01_17_19_swv_gc_control_dap_processed.csv")

ggplot(swv_gc_control %>% filter(reactor=='transfer' & electrode_from_swv=='i1' & rep>0), aes(x = signal_from_swv, y = signal_from_gc, color=factor(run)))+
  geom_line()+
  geom_point()+
  geom_smooth(method='lm',se=F)+
  scale_color_viridis(discrete = T)
```

```{r}
swv_gc_control_lms <- swv_gc_control %>% 
  filter(reactor=='transfer' & rep>0 & electrode_from_swv=='i1') %>%
  group_by(run,treatment,electrode_from_swv) %>% 
  do(tidy(lm(signal_from_gc~signal_from_swv,.)))
```
